
_extramodules=extramodules-5.6
_kver=$(cat /lib/modules/${_extramodules}/version)

pkgname=rtl8723de
_pkgname=rtlwifi_new
pkgver=2020.05.09
_commit=0a751e30e3aed5e6e0f72123031012abda91ca1a
pkgrel=1
pkgdesc="Drivers for the rtl8723de chipset for wireless adapters."
arch=('x86_64')
url="https://github.com/lwfinger/rtlwifi_new"
license=('GPL-2.0')
depends=('linux>=5.6.5' 'linux<5.7')
makedepends=('linux-headers' 'elfutils')
install=rtl8723de.install
options=('!strip')
# checkout extended branch
source=("https://github.com/lwfinger/rtlwifi_new/archive/${_commit}.zip")
md5sums=('2f76a624e61e087353b827909933cb20')


build() {
  cd ${_pkgname}-${_commit}
  
  #patch -p1 -i ${srcdir}/80a0cb2c1aa10e52bc653e7455a6f1b64fdccd09.diff
  
  make 
}

package() {
  cd ${_pkgname}-${_commit}
  
  install -D -m644 rtl8723de/rtl8723de.ko ${pkgdir}/lib/modules/${_kver}/kernel/drivers/net/wireless/rtl8723de.ko
  
  # sign the module
  _file=/usr/src/linux-${_kver}/scripts/sign-file
  _pem=/$HOME/signing_key.pem
  _key=/$HOME/signing_key.x509
  
  ${_file} sha256 ${_pem} ${_key} ${pkgdir}/lib/modules/${_kver}/kernel/drivers/net/wireless/rtl8723de.ko
  
  install -d -m755 ${pkgdir}/etc/modprobe.d
  echo "options rtl8723de ant_sel=2" >> "${pkgdir}/etc/modprobe.d/rtl8723de.conf"
  sed -i -e "s/EXTRAMODULES='.*'/EXTRAMODULES='${_extramodules}'/" "${startdir}/rtl8723de.install"
}
