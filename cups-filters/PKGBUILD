
pkgname=cups-filters
pkgver=1.21.0
pkgrel=1
pkgdesc="OpenPrinting CUPS Filters"
arch=('x86_64')
url="http://www.linuxfoundation.org/collaborate/workgroups/openprinting"
license=('GPL')
depends=('lcms2' 'poppler' 'qpdf')
makedepends=('ghostscript' 'ttf-dejavu' 'python3') 
optdepends=('ghostscript: for non-PostScript printers to print with CUPS to convert PostScript to raster images'
            'foomatic-db: drivers use Ghostscript to convert PostScript to a printable form directly'
            'foomatic-db-engine: drivers use Ghostscript to convert PostScript to a printable form directly'
            'foomatic-db-nonfree: drivers use Ghostscript to convert PostScript to a printable form directly')
conflicts=('foomatic-filters')
provides=('foomatic-filters')
replaces=('foomatic-filters')
backup=(etc/fonts/conf.d/99pdftoopvp.conf)
options=('!libtool')
source=("https://www.openprinting.org/download/cups-filters/${pkgname}-${pkgver}.tar.xz"
        "https://github.com/OpenPrinting/cups-filters/commit/07a0a423a8469a2dd6d7f64bb3b62ba6ac42cc28.diff")
md5sums=('cbc5498bc4b9ab876c1fc5582d974bbe'
         '608b2097762a3a7595892a2ef48d6b5d')

build() {
  cd ${pkgname}-${pkgver}
  #patch -p1 -i ${srcdir}/07a0a423a8469a2dd6d7f64bb3b62ba6ac42cc28.diff
  #sed -e "s|cpp/poppler-version.h|poppler/cpp/poppler-version.h|" -i filter/pdftoopvp/oprs/OPRS.cxx
  
  ./configure --prefix=/usr  \
    --sysconfdir=/etc \
    --with-rcdir=no \
    --enable-avahi \
    --with-test-font-path=/usr/share/fonts/TTF/DejaVuSans.ttf \
    --disable-mutool
  make
}

check() {
  cd ${pkgname}-${pkgver}
  
  make -k check
}

package() {
  cd ${pkgname}-${pkgver}
  make DESTDIR=$pkgdir/ install

  rm -f ${pkgdir}/usr/lib/*.a
  # systemd service
  install -Dm644 utils/cups-browsed.service ${pkgdir}/usr/lib/systemd/system/cups-browsed.service
  sed -i 's|cups.service|org.cups.cupsd.service|g' ${pkgdir}/usr/lib/systemd/system/cups-browsed.service
}
